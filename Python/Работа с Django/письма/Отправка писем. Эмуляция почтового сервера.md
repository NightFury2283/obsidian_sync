

Пользователи сайта могут забыть свой пароль — и в результате потеряют доступ к аккаунту и к собственным материалам на сайте. Чтобы помочь таким забывчивым пользователям — в Django встроена система восстановления пароля, и один из ключевых инструментов в этой системе — автоматическая отправка электронного письма:

- через специальную форму пользователь отправляет адрес своей электронной почты, указанный в его профайле;
- если этот адрес обнаружен в базе данных — на почту пользователя высылается письмо со специальной одноразовой ссылкой;
- перейдя по ссылке, пользователь получает возможность создать новый пароль для своего аккаунта.

Чтобы эта схема заработала — нужно настроить проект так, чтобы он мог отправлять электронные письма. Прямо сейчас этим и займёмся.

## Email-бэкенд Django

Под термином «бэкенд» в Django подразумевается набор модулей или классов, которые решают определённую задачу. Для решения одной задачи может существовать несколько вариантов — несколько различных бэкендов; почти всегда можно создать и свой собственный, кастомный бэкенд.

В Django бэкенды применяются в механизмах аутентификации, в настройках кеширования (это механизм для быстрого получения часто используемых данных); есть бэкенды для работы с шаблонами, есть и бэкенды для работы с почтой.

Вот список встроенных в Django email-бэкендов — они не требуют отдельной установки:

1. [SMTP-бэкенд](https://docs.djangoproject.com/en/3.2/topics/email/#smtp-backend) (вариант по умолчанию) — отправляет реальные письма через внешний по отношению к Django почтовый сервер, работающий по протоколу SMTP. Например, можно воспользоваться услугами Яндекс Почты или какого-то другого общедоступного почтового сервера: Django-проект соединится с почтовым сервером и отправит почту через него. Для работы с SMTP-бэкендом нужно указать данные для подключения к почтовому серверу, логин и пароль для почтового ящика, от имени которого будут отправлены письма, и некоторые другие настройки.
2. [Консольный бэкенд](https://docs.djangoproject.com/en/3.2/topics/email/#console-backend) не отправляет письма, а только выводит содержимое писем в консоль:
3. 1. [Файловый бэкенд](https://docs.djangoproject.com/en/3.2/topics/email/#file-backend) тоже не отправляет писем: вместо отправки письма сохраняются в файл.
4. [Бэкенд «в памяти»](https://docs.djangoproject.com/en/3.2/topics/email/#in-memory-backend) — вместо отправки письма этот бэкенд сохраняет письма в специальный атрибут `django.core.mail.outbox`. Этот атрибут создаётся при отправке первого письма и представляет из себя список с письмами. По сути, письма хранятся в оперативной памяти, поэтому бэкенд так и называется. Побольше узнать о `django.core.mail.outbox` можно [из документации](https://docs.djangoproject.com/en/3.2/topics/testing/tools/#django.core.mail.django.core.mail.outbox).
5. [Бэкенд-заглушка](https://docs.djangoproject.com/en/3.2/topics/email/#dummy-backend) — не отправляет и не сохраняет писем: он вообще не выполняет никаких действий. Этот бэкенд бывает полезен, когда надо временно отключить работающие почтовые бэкенды. При попытке отправить письмо на реально существующий адрес этот бэкенд предохраняет от ошибок, которые могут появиться в подключенном по умолчанию SMTP-бэкенде.

Для реальной отправки писем предназначен только SMTP-бэкенд; все остальные бэкенды используются для разработки или тестирования.

Подключать к проекту реальный почтовый сервер сейчас нет необходимости, поэтому применим файловый бэкенд: все «отправленные» письма будут лежать в специальной директории проекта и будут доступны даже при остановленном веб-сервере разработки.

## Сохранение писем в файлы

Нужный email-бэкенд указывается в константе `EMAIL_BACKEND` в настройках проекта.

```python
# settings.py
...
EMAIL_BACKEND = 'django.core.mail.backends.<тип бэкенда>.EmailBackend'
...
```


Подключите к проекту **filebased.EmailBackend**: он будет сохранять текст отправленных электронных писем в файлы в отдельную директорию. Для этого добавьте в _settings.py_ такой код:


```python
# settings.py
...
# Подключаем бэкенд filebased.EmailBackend:
EMAIL_BACKEND = 'django.core.mail.backends.filebased.EmailBackend'
# Указываем директорию, в которую будут сохраняться файлы писем:
EMAIL_FILE_PATH = BASE_DIR / 'sent_emails'
```

Теперь при выполнении кода, который должен отправлять письма, Django будет сохранять содержимое писем в корне проекта, в директории _sent_emails/_. Если эта директория не существует — она будет создана после «отправки» первого письма.

В модуле аутентификации отправка писем настроена по умолчанию, но будет полезно посмотреть на примере, как это делается.

## Отправка писем из кода программы

В Django есть несколько вариантов отправки писем — отправка одиночного письма, отправка множества писем за раз, отправка писем со вложениями, отправка в формате HTML — все эти способы описаны [в документации](https://docs.djangoproject.com/en/3.2/topics/email/#module-django.core.mail).

Рассмотрим простейший случай: отправку обычного текстового письма.

Такие письма отправляются с помощью функции `send_mail()` из модуля `django.core.mail`:


```python
# Импорт функции для отправки почты.
from django.core.mail import send_mail

# Пример вызова функции:
send_mail(
    subject='Тема письма',          
    message='Текст сообщения',  
    from_email='from@example.com',
    recipient_list=['to@example.com'],
    fail_silently=True,
)
```


В функцию `send_mail()` передаются обязательные параметры `subject`, `message`, `from_email` и `recipient_list`:

- `subject`: **тема письма** (строка).
- `message`: **текст сообщения** (строка).
- `from_email`: **от кого** (строка); если аргумент не указан — Django возьмёт значение параметра `DEFAULT_FROM_EMAIL` из настроек проекта.
- `recipient_list`: **адреса получателей** (список строк). Получатели увидят, кому ещё было отправлено это письмо: адреса всех получателей отобразятся в поле «Кому».
- `fail_silently`: необязательный аргумент. Если для этого аргумента установлено значение `True`, то ошибка отправки письма не вызовет ошибки приложения.

Функцию `send_mail()` можно вызвать из любого места программного кода — и письмо будет отправлено.

Для эксперимента настроим почтовые уведомления для администратора сайта — будем отправлять ему письмо всякий раз, когда кто-то представляется именем одного из участников группы “The Beatles”.

Добавьте в _birthday/forms.py_ код для отправки письма администратору:


```python
#  birthday/forms.py
...
# Импорт функции для отправки почты.
from django.core.mail import send_mail

BEATLES = {'Джон Леннон', 'Пол Маккартни', 'Джордж Харрисон', 'Ринго Старр'}


class BirthdayForm(forms.ModelForm):

    ...

    def clean(self):
        super().clean()
        first_name = self.cleaned_data['first_name']
        last_name = self.cleaned_data['last_name']
        if f'{first_name} {last_name}' in BEATLES:
            # Отправляем письмо, если кто-то представляется 
            # именем одного из участников Beatles.
            send_mail(
                subject='Another Beatles member',
                message=f'{first_name} {last_name} пытался опубликовать запись!',
                from_email='birthday_form@acme.not',
                recipient_list=['admin@acme.not'],
                fail_silently=True,
            )
            raise ValidationError(
                'Мы тоже любим Битлз, но введите, пожалуйста, настоящее имя!'
            )
```


Запустите проект и отправьте через форму имя любого участника Beatles. Если всё настроено правильно, то в корневой директории в папке _/sent_mails_ появится текстовый файл с письмом:

```
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Subject: Another Beatles member
From: birthday_form@acme.not
To: admin@acme.not
Date: Sat, 04 Feb 2022 23:35:11 -0000
Message-ID: <167555371154.3492.7889481566445581248@WIN-9S7158224423ZLC000015>

Ринго Старр пытался опубликовать запись!
-------------------------------------------------------------------------------
```


Так можно отправлять письма из любой функции; отправка писем — востребованная задача, и Django позаботился о том, чтобы решение этой задачи не было сложным.


