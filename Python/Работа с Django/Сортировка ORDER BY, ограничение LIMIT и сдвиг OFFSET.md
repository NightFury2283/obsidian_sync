
[[Питон Практикум]]
[[Фреймворк Django. Работа с проектами]]
[[Python]]

Для начала упорядочим по алфавиту сорта мороженого, которые выводятся на главную страницу проекта и на страницу со списком всех сортов.

По умолчанию Django никак не гарантирует порядок сортировки объектов в QuerySet, но в Django ORM есть пара способов, позволяющих отсортировать объекты по нужному полю (или даже по нескольким):

- указать условие сортировки в классе `Meta` в модели — и тогда все QuerySet с объектами этой модели будут сортироваться по заданному правилу;
- при составлении запроса применить метод `.order_by()` интерфейса `objects` — тогда сортировка будет применена только к QuerySet, полученному через этот конкретный запрос.

### Сортировка через класс Meta в модели

Если сортировать объекты модели планируется одинаково при всех запросах — порядок сортировки можно объявить прямо в модели:


```python
# <название_приложения>/models.py

class <Модель>(models.Model):
    ...

    class Meta:
        ordering = ('<название_поля>',)
```


Любой запрос к этой модели вернёт QuerySet, отсортированный по правилу, указанному в классе `Meta`. Код из листинга отсортирует QuerySet по возрастанию: от меньших к большим значениям, если поле содержит числа; по алфавиту от A до Z и от А до Я — если поле содержит строки.

При таких настройках модели в SQL-запросы будет добавлена инструкция `ORDER BY`


Чтобы поменять порядок сортировки и упорядочить объекты от больших значений к меньшим — достаточно поставить символ «минус» `-` перед названием поля, по которому проводится сортировка:

```python
ordering = ('-<название_поля>',) 
# SQL-запрос: ORDER BY <название_поля> DESC
```


Можно отсортировать и по нескольким полям




## Метод .order_by()

Порядок сортировки можно указать и в конкретном запросе; для этого у `objects` есть метод `.order_by()`:

```python
<Модель>.objects.order_by('<название_поля>')
```


Если правила сортировки указаны одновременно в `Meta` и в `objects.order_by()` — будут применены правила из `objects.order_by()`. Такое «переопределение» сортировки применяют, если в большинстве случаев при работе с моделью нужен один принцип сортировки (его можно указать в `Meta`), а в каком-то частном случае требуется иная сортировка (её указывают в `objects.order_by()`).

Сортировку, установленную в `Meta`, в каких-то запросах можно и вовсе отключить — для этого нужно вызвать метод `objects.order_by()` без параметров. Сортировка увеличивает время запроса, и если в каком-то случае она не требуется — есть смысл её отключить.

Метод `.order_by()` может сортировать и по нескольким полям




### Ограничение и сдвиг выборки: LIMIT, OFFSET


Для ограничения количества возвращаемых записей в SQL применяются операторы `LIMIT` и `OFFSET`. Django ORM тоже так умеет: ограничить количество объектов в QuerySet можно с помощью **срезов** — ведь QuerySet хранит список словарей или объектов модели, и к нему можно применять все инструменты, которыми в Python обрабатываются списки.

Ограничим число возвращаемых объектов до трёх:

```python
ice_cream_list = IceCream.objects.values(
    'id', 'title', 'description'
).filter(
    is_published=True, is_on_main=True
).order_by('title')[1:4]
```

При создании SQL-запроса конструкция `[1:4]` преобразуется в

```sql
...

LIMIT 3 -- Количество записей. Разница между первым и вторым значениями (4 - 1) 
OFFSET 1 -- На сколько элементов сдвинуть выборку - первое значение в срезе (1)
```


