
[[Питон Практикум]]
[[Фреймворк Django. Работа с проектами]]

Введём новый термин — фикстуры.

Это выгруженные в определённом формате данные из БД. Штука, Фикстуры могут служить резервной копией данных — их можно загрузить в БД и наполнить её. Также фикстуры можно передать кому-то. Можно придумать ещё одиннадцать причин, «почему нужно научиться работать с фикстурами», но пока что хватит и этих.


Django умеет работать с разными форматами фикстур, а по умолчанию выгружает данные в формате JSON (от англ. _JavaScript Object Notation_). Изначально этот формат был придуман для языка JavaScript, но оказался настолько удобным, что стал одним из стандартных форматов обмена данными; с форматом JSON умеют работать очень многие языки программирования, и Python — в их числе.

Если выгрузить в JSON записи из таблицы `ice_cream_icecream` (за её описание отвечает модель `IceCream`), фикстуры будут выглядеть примерно так:

```json
[
{
  "model": "ice_cream.icecream",
  "pk": 1,
  "fields": {
    "is_published": true,
    "is_on_main": false,
    "title": "Классический пломбир",
    "description": "Настоящее мороженое, для истинных ценителей вкуса. Если на столе появляется пломбир — это ненадолго.",
    "wraper": null,
    "category": 1,
    "topings": [
      1,
      2
    ]
  }
},

{
  // Следующая запись
  "model": "ice_cream.icecream",
  "pk": 2,
  ...
}
]
```


Активируйте виртуальное окружение, перейдите в каталог с _manage.py_ и выполните команду для загрузки фикстур в БД:


```bash
python manage.py loaddata db.json
```

В БД появились новые записи.

> Важно: если структура БД и фикстур не совпадает — данные не будут загружены, а в консоли появится сообщение, что данные-то есть, а загрузить их некуда.


## Создание фикстур

В Django фикстуры создаются командой `dumpdata`: после команды указывают дополнительные аргументы, а после ключа `-o` — название файла, в который нужно сохранить данные. Можно сохранить в фикстуры всю базу целиком, а можно — только выбранные модели.

Выгружаем данные всех моделей из БД:

```bash
python manage.py dumpdata -o db.json 
```

Или только данные из приложения **ice_cream**:

```bash
python manage.py dumpdata ice_cream -o ice_cream.json
```

А можно сохранить только данные из отдельной таблицы:

```bash
# Сохраняем данные модели icecream приложения ice_cream:
python manage.py dumpdata ice_cream.icecream -o ice_cream_icecream.json
```


Можно экспортировать данные из нескольких моделей, для этого их названия перечисляются через пробел после команды `dumpdata`.

Есть возможность экспортировать все таблицы за исключением перечисленных:

```bash
# Сохраняем все данные из проекта, кроме данных модели icecream приложения ice_cream:
python manage.py dumpdata --exclude ice_cream.icecream -o without_ice_cream_icecream.json
```


После выполнения этой команды в папке проекта появится файл в формате _.json_; в нём будет описание моделей и данные таблиц, связанных с этими моделями.

По умолчанию данные экспортируются в одну строку без какого-либо форматирования. За счёт этого уменьшается объём файла; программам не нужно форматирование, они и так прочтут файл. А вот человеку будет неудобно читать строку в несколько тысяч (а то и в несколько сотен тысяч) знаков.

При экспорте данных можно указать, каким количеством отступов должны отбиваться вложенные элементы; тогда дамп будет разбит построчно, а вложенные элементы обозначены заданным количеством отступов. За такое форматирование отвечает ключ `--indent`:

```bash
python manage.py dumpdata --indent 2 -o indented_db.json
```


Чтобы Python выводил данные в кодировке `utf-8` (именно она нужна для корректной работы) — нужно вызывать Python с ключом `-Xutf8`.

Этот ключ относится именно к Python: он должен стоять после названия программы:

```bash
python -Xutf8 manage.py dumpdata --indent 2 -o indented_db.json
```


## Ещё одна засада

Если данные были экспортированы на одном компьютере, а залить базу надо на другом — возникнет проблема: при импорте данных будет выброшено исключение `IntegrityError`.


Служебная таблица `contenttypes` создаётся и заполняется автоматически во время совершения миграции. В ней содержится информация, какие приложения и модели существуют в проекте.

Чтобы избежать ошибки, при создании фикстуры нужно исключить таблицу `contenttypes`:

```bash
python manage.py dumpdata --exclude contenttypes -o db.json
```


Проблемы при импорте могут возникнуть и с таблицей `auth.permission`, которая хранит информацию о правах пользователей. Эту таблицу тоже можно исключить из фикстур: `--exclude auth.permission`.

> Коротко о заполнении БД, выгрузке данных, моделях, миграциях и CRUD-операциях — в [шпаргалке](https://code.s3.yandex.net/Python-dev/cheatsheets/029-django-orm-modeli-migratsii-crud-vygruzka-v-json/029-django-orm-modeli-migratsii-crud-vygruzka-v-json.html).

