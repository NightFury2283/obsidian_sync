
[[Питон Практикум]]
[[Фреймворк Django. Работа с проектами]]
[[Python]]

Для решения одной и той же задачи можно отправить один запрос, а можно — несколько десятков. Лучше — меньше: ведь при большом количестве пользователей лишние запросы создадут ненужную нагрузку на БД.

Чтобы сравнить, в каком случае отправляется больше запросов, а каком — меньше, установите в проект приложение [django-debug-toolbar](https://django-debug-toolbar.readthedocs.io/en/latest/) (**DjDT**). Оно покажет, какие запросы отправляет ORM и что вы получаете из базы данных.

Подключить его — дело трёх минут:

### Middleware

В дословном переводе **middleware** — это «промежуточное программное обеспечение»; middleware обрабатывает:

- запросы перед тем, как они попадают во view-функцию
- и ответы view-функции — перед тем, как они отправятся пользователю.

В проекте может быть несколько middleware, и в общем виде **запрос** в Django проходит такой путь:

```
[...] -> middleware1 -> middleware2 -> middleware_n -> view-функция
```

При развёртывании проекта в этом списке уже есть несколько middleware. Django хранит их список в _settings.py_ в константе `MIDDLEWARE`. Удалять их не рекомендуется; в этот список можно добавлять собственные middleware.


### Устанавливаем Django Debug Toolbar

Активируйте виртуальное окружение и выполните команду

```bash
pip install django-debug-toolbar==3.8.1
```


Сразу добавьте **DjDT** в список пакетов, используемых в проекте. Список зависимостей хранят в файле **requirements.txt**, как правило _—_ в корневой папке проекта.

Для обновления списка пакетов **перейдите в корневую папку проекта** и (при запущенном виртуальном окружении конечно же) выполните команду

```bash
pip freeze > requirements.txt
```


После установки приложения зарегистрируйте и настройте приложение **DjDT** в файле _anfisa_for_friends/settings.py_:

```python
# anfisa_for_friends/settings.py

...

INSTALLED_APPS = [
    # В проекте уже зарегистрировано несколько приложений.
    ...
    # Регистрируем новое приложение в проекте:
    # обязательно ниже, чем django.contrib.staticfiles.
    'debug_toolbar',
]

# MIDDLEWARE — список промежуточных программных слоёв, подключённых к проекту.
# DebugToolbarMiddleware будет обрабатывать информацию из запросов
# и отображать её в панели Django Debug Toolbar.
# Добавьте DebugToolbarMiddleware в самый конец списка.
MIDDLEWARE = [
    ...
    'debug_toolbar.middleware.DebugToolbarMiddleware',
]

# Добавьте в settings.py эту константу, чтобы DjDT знал,
# запросы с каких IP он должен обрабатывать.
INTERNAL_IPS = [
    '127.0.0.1',
]
```


Последний штрих: в головной файл _anfisa_for_friends/urls.py_ добавьте новое правило для режима отладки:


```python
# anfisa_for_friends/urls.py
# Импортируем информацию из настроек.

...

from django.conf import settings

urlpatterns = ...

# Если проект запущен в режиме разработки...
if settings.DEBUG:
    import debug_toolbar
    # Добавить к списку urlpatterns список адресов из приложения debug_toolbar:
    urlpatterns += (path('__debug__/', include(debug_toolbar.urls)),)
```


После подключения и настройки DjDT дизайн страниц изменится: появится боковое меню с несколькими подразделами. Во вкладке SQL можно увидеть запросы, на основе которых формируется запрошенная страница.

Например, вот запрос, который формирует страницу по адресу `127.0.0.1:8000/admin/`:


![[Pasted image 20250510210208.png]]


Большинство Django-программистов подключают **DjDT** в самом начале работы над проектом: это упрощает разработку и помогает избежать многих проблем. Обычному пользователю эта панель не нужна, поэтому **DjDT** настраивают так, чтобы она была видна только в режиме разработки (при настройке `DEBUG = True` в _settings.py_).

## На заметку

Побольше узнать про Django Middleware можно [в документации Django](https://docs.djangoproject.com/en/3.2/topics/http/middleware/).
