
[[Питон Практикум]]
[[SQL]]
[[Отношения «один к одному»]]
[[Отношения «многие к одному»]]

Для привязки данных из других таблиц создадим в таблице **video_products** поля, в которых будем хранить `id` связанной записи из таблиц **original_titles**, **product_types** и **directors.**

В таблице **video_products** в полях `original_title_id`, `type_id` и `director_id` указаны `id` соответствующих записей в других таблицах.

Названия полей, ссылающихся на другие таблицы, могут быть любыми, но лучше составлять их по принципу `имяТаблицы_имяПоля`.

В остальных таблицах будет храниться такая информация:

![[Pasted image 20250504151131.png]]


Для сериала «Она написала убийство» связи с другими таблицами будут выглядеть так:

![[Pasted image 20250504151152.png]]


## Связи между таблицами

В реляционных базах данных может быть три типа связей:

- Один к одному (1:1 или _one-to-one_): фильм → оригинальное название.
- Многие к одному (M:1 или _many-to-one_): фильмы → тип.
- Многие ко многим (N:M или _many-to-many_): фильмы → режиссёры.

Чтобы настроить эти связи — в каждой из таблиц должен быть _primary key_ (**PK**, идентификатор записи; его значение должно быть уникально в пределах таблицы), а в таблицах, которые ссылаются на другие таблицы, понадобятся поля с внешними ключами (**FK**, _foreign key_), где будет указано, куда ссылается каждая конкретная запись.


## Связь «один к одному» (1:1)

В жизни отношения _один к одному_ довольно часты:

- **Сотрудник** **— паспорт.** У любого сотрудника компании обязательно есть паспорт (людей без паспорта отдел кадров просто не может взять на работу). И паспорт у сотрудника только один. В базе данных у кадровиков между таблицами **staff** и **passports** должна быть установлена связь 1:1.

### Один к одному: обязательная связь

Для хранения информации о сотрудниках и их паспортах можно создать таблицы **staff** и **passports** и организовать между ними **обязательную** связь «один к одному»: в поле `passport_id` не может стоять `NULL`.

![[Pasted image 20250504152635.png]]


### Один к одному: необязательная связь

Между таблицами можно установить **необязательную** связь «один к одному». Например, отдел кадров ведёт учёт не только паспортов, но и автомобильных удостоверений своих сотрудников. Данные об удостоверениях можно хранить в таблице **driving_licenses**. У одного сотрудника может быть только одно водительское удостоверение.

Но у кого-то может и не быть водительского удостоверения. Значит, связь между таблицами **staff** и **driving_licenses** — **необязательная**, и в поле `driving_license_id` должно быть разрешено значение `NULL`.


## Связь «многие к одному» (M:1)

В реляционных БД чаще всего встречается связь «многие к одному». Основная идея этой связи в том, что много сущностей можно связать с одной.

Эта связь описывает, например, такие отношения:

- **Кинотеатр и залы**: в одном кинотеатре может быть много залов. **Множество** залов связаны с **одним** кинотеатром.
- **Место рождения**: в определённом городе может родиться много детей. **Много** детей связаны с **одним** городом.

### Многие к одному: обязательная связь

В кинотеатре есть хотя бы один зал с экраном — иначе это не кинотеатр. Кинозалов может быть много или он может быть один — но он обязательно есть.

Каждый определённый кинозал обязательно расположен в каком-то кинотеатре, он не может существовать сам по себе. Следовательно, связь **обязательна**: каждая запись таблицы **cinema_halls** должна ссылаться на запись в **cinema**.


![[Pasted image 20250504152838.png]]


### Многие к одному: необязательная связь

Автомобильная стоянка может вмещать множество машин. Но может случиться и так, что автомобиль стоит не на парковке, а, например, на балконе у хозяина; в такой ситуации автомобиль не привязан ни к одной из парковок.

Связь между автомобилем и парковкой — многие к одному, **необязательная**: в поле `parking_id` может быть `NULL`.


![[Pasted image 20250504152938.png]]


При создании обязательных связей 1:1 и M:1 важен порядок, в котором создаются связанные записи. Например, в случае связи «сотрудник — паспорт» сперва должна быть создана запись о паспорте и только после этого — запись о сотруднике: ведь в записи о сотруднике есть обязательное для заполнения поле `passport_id`, но его не удастся заполнить, если в таблице **passport** не создана запись о паспорте сотрудника.

Подобная ситуация возникнет и при обязательной связи M:1 — нельзя создать запись о кинозале, не создав запись о кинотеатре.


## Связь «многие ко многим» (N:M)

Это самый сложный тип связей: нескольким записям из одной таблицы могут соответствовать несколько записей из другой.

- **Учителя и классы.** В школе работают несколько учителей-предметников, каждый из них преподаёт в нескольких классах; каждому классу преподают несколько учителей. Если создать таблицы **teachers** и **classes** — то между ними должна быть установлена связь «многие ко многим».
- **Фильмы — режиссёры.** Каждый режиссёр может снять несколько фильмов. У одного фильма может быть несколько режиссёров.

![[Pasted image 20250504153154.png]]


На уровне базы данных нельзя установить прямую связь N:M между двумя таблицами. Для такой связи необходима **промежуточная таблица**.

Название промежуточной таблицы принято составлять из имён тех таблиц, которые связаны через неё; в нашем случае получилось название **directors__video_products**.

Поля таблицы **directors__video_products**:

- `video_product_id`: ссылка на `id` записи в `video_products`.
- `director_id`: ссылка на `id` записи в таблице `directors`.

Посредством этой таблицы можно связать один фильм с несколькими режиссёрами и одного режиссёра — с несколькими фильмами. Обратившись к этой таблице, можно получить информацию о связях.

При связи «многие ко многим» в связываемых таблицах не нужно поле с внешним ключом; обратите внимание — в таблице **video_products** нет никаких ссылок на таблицу **directors**, а в **directors** нет ссылок на **video_products**.


![[Pasted image 20250504153421.png]]


## Композитный первичный ключ

Присмотримся повнимательнее к промежуточной таблице **directors__video_products**.

Отдельные значения в колонках `video_product_id` и `director_id` могут повторяться — так, в колонке `video_product_id` повторяется значение **6** (ссылка на фильм «Она написала убийство»); в колонке `director_id` дважды встречается единица (ссылка на режиссёра Текса Эйвери) и дважды — шестёрка (ссылка на Энтони Пуллена Шоу).

![[Pasted image 20250504153753.png]]


**Пара значений этих полей может служить первичным ключом.**

##### Первичные ключи, состоящие из значений нескольких полей, называют **композитными первичными ключами**. Например, пара «режиссёр-фильм» — это композитный ключ: ведь режиссер не может снять один и тот же фильм несколько раз.

При создании связи «многие ко многим» сначала должны быть созданы записи в связываемых таблицах и только после этого — записи в промежуточной таблице.

Другим примером композитного первичного ключа может быть пара «серия-номер» паспорта. Ни серия, ни номер не обязаны быть уникальными, но в паре эти значения составляют уникальный идентификатор, определяющий документ и его владельца.

