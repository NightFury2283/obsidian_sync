[[Питон Практикум]]
[[SQL]]

### Группировка данных: GROUP BY

В SQL есть возможность сгруппировать записи, у которых совпадает значение определённого поля; после группировки можно проводить над полученными группами необходимые операции.

Самый простой вариант использования **GROUP BY** — найти «группы», объединённые одинаковым значением в заданной колонке.

```sql
SELECT product_type
FROM video_products
GROUP BY product_type;
```


Все записи с одинаковыми значениями в поле `product_type` были объединены в группы, и в ответ на запрос вернулось по одной записи из каждой группы.

```sql
('Мультсериал',)
('Мультфильм',)
('Сериал',)
('Фильм',)
```


### Чудеса в примерах

**Посчитаем (COUNT), сколько в таблице фильмов каждого типа** — сколько фильмов, сколько сериалов, сколько мультфильмов и мультсериалов:

```sql
-- Показать значение поля product_type и значение счётчика...
SELECT product_type,
       COUNT(*)
FROM video_products
-- ...для групп записей с одинаковым значением в поле product_type
GROUP BY product_type;
```

```bash
('Мультсериал', 2)
('Мультфильм', 1)
('Сериал', 3)    
('Фильм', 4)
```


##### В выборке отображаются значения полей первой записи из каждой группы.



**Просуммируем кассовые сборы (SUM)** для фильмов разного типа:

```sql
SELECT product_type,
       SUM(gross)
FROM video_products
GROUP BY product_type;
```

```bash
('Мультсериал', None)
('Мультфильм', None)
('Сериал', None)
('Фильм', 318868922)
```


Python преобразовал `NULL` в аналогичное по смыслу значение `None`.

Данные, которые попадут в группировку, можно предварительно отфильтровать через `WHERE`. Объединим фильмы в группы по типам и просуммируем кассовые сборы для каждой группы; но в группы включим лишь фильмы, выпущенные после 1990-го года; выведем название группы и сумму сборов — `SUM(gross)`:


```sql
SELECT product_type,
       SUM(gross)
FROM video_products
WHERE release_year > 1990
GROUP BY product_type;
```

```bash
('Сериал', None)
('Фильм', 137298489)
```



### Фильтрация групп: HAVING

Инструкция `HAVING` позволяет выполнить **фильтрацию групп**: она определяет, какие группы будут включены в результирующую выборку. Работа `HAVING` во многом аналогична применению `WHERE`; но `WHERE` применяется для фильтрации строк, а `HAVING` — для фильтрации групп.

Исключим из выборки все группы, в которых сумма кассовых сборов равна `NULL`:

```sql
SELECT product_type,
       SUM(gross)
FROM video_products
GROUP BY product_type
-- Это условие относится к группам:
HAVING SUM(gross) IS NOT NULL;
-- ('Фильм', 318868922)
```


