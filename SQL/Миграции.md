[[Питон Практикум]]
[[Фреймворк Django. Работа с проектами]]
[[SQL]]

После того как модели созданы, на их основе нужно создать таблицы в БД. Django ORM делает это с помощью механизма **миграций**. Миграции выполняются в два этапа:

1. Разработчик запускает команду `python manage.py makemigrations`. По этой команде Django ORM прочтёт и проанализирует все модели проекта, проверит, не приведут ли предполагаемые изменения к проблемам. Если всё хорошо — список планируемых изменений будет сохранён в папке _migrations/_ приложений в отдельных файлах. Если в какой-то момент модели снова будут изменены и снова потребуются миграции — при следующем выполнении команды `makemigrations` будет создан новый файл миграций; таким образом информация о миграциях сохраняется и накапливается. Это даёт возможность, например, «откатиться» к какому-то из предыдущих состояний БД. При выполнении команды `makemigrations` никаких изменений в БД не вносится.
2. После того как миграции созданы, разработчик запускает команду `python manage.py migrate`; основываясь на файлах миграций, Django создаст и выполнит SQL-запросы, формирующие или изменяющие таблицы.

> Файлы миграции каждого приложения следует добавлять в git: миграции — это неотъемлемая часть проекта.


### Этап 1. Создаём файлы миграций: makemigrations

Перейдите в директорию с файлом _manage.py_ (виртуальное окружение должно быть активно) и выполните команду

```bash
python manage.py makemigrations
```

Запустится процесс проверки моделей, после этого будет создан файл миграций.

В консоли появится сообщение, что в директории _ice_cream/migrations/_ создан файл _0001_initial.py_, а в нём записаны операции, которые Django ORM планирует выполнить:


![[Pasted image 20250509183952.png]]


Файл миграций _—_ это инструкция для составления SQL-запроса. Увидеть запрос, который будет создан, можно с помощью команды

```bash
 python manage.py sqlmigrate ice_cream 0001 
```

где `ice_cream` — имя приложения, а `0001` — это номер миграции.


### Этап 2. Применяем миграции: migrate

Подготовка окончена, выполняем миграции: при активированном виртуальном окружении из директории с файлом _manage.py_ выполните команду


```bash
python manage.py migrate
```


Отметка `OK` означает, что очередная операция успешно завершена.

Будет создано и несколько таблиц для встроенных приложений Django: _auth_, _admin_, _sessions_, _contenttypes_.

Начальные миграции для этих таблиц встроены в соответствующие приложения, и Django оставалось только применить их.

Проект **Анфиса для друзей** готов к работе с данными! Создана база данных SQLite, а в ней — таблицы для приложения **ice_cream** и таблицы служебных приложений.

## Окно в базу данных

После выполнения миграций будет интересно заглянуть в базу данных (файл db.sqlite3) и посмотреть, что там новенького.

![[Pasted image 20250509184508.png]]


> База данных не должна попасть в git, поэтому нужно добавить в _.gitignore_ правило, исключающее файлы _.sqlite_ и _.sqlite3_ из репозитория: файлы БД SQLite могут быть с разным расширением.


### Шпаргалка

Полезные команды при миграциях:

- `python manage.py migrate` применение миграции.
- `python manage.py makemigrations` создание новых миграций на основе изменений, внесённых в модели.
- `python manage.py sqlmigrate <имя приложения> <номер миграции>` отображает SQL-запросы, которые будут отправлены при миграции.